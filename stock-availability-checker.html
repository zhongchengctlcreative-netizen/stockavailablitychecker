<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Availability Checker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); padding: 30px; }
        h1 { color: #333; margin-bottom: 10px; text-align: center; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; }
        .upload-section { background: #f8f9fa; border: 1px dashed #ccc; border-radius: 6px; padding: 12px; text-align: center; margin-bottom: 16px; transition: all 0.2s; }
        .upload-section:hover { border-color: #667eea; background: #f0f0ff; }
        .upload-section.collapsed { padding: 6px; margin-bottom: 8px; display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap; }
        /* Keep organisation (sheet selector) and search visible after collapse */
        .upload-section.collapsed .controls { display: none !important; }
        .upload-section.collapsed #sheetSelectorContainer, .upload-section.collapsed #searchContainer { display: flex !important; }
        .upload-section.collapsed #fileInfo { display: inline-block; margin: 0; }
        .file-input { display: none; }
            .upload-btn { background: #667eea; color: white; padding: 8px 16px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; transition: background 0.2s; }
            .upload-section .hint { font-size: 12px; color: #6b7280; margin-top: 6px; }
            .upload-btn:hover { background: #5568d3; }
        .upload-btn:hover { background: #5568d3; }
        .file-info { margin-top: 15px; color: #666; font-style: italic; }
        .results { margin-top: 30px; }
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .summary-card.oos { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .summary-card.in-stock { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .summary-card h3 { font-size: 14px; margin-bottom: 10px; opacity: 0.9; }
        .summary-card .value { font-size: 32px; font-weight: bold; }
        .oos-list { background: #fff5f5; border-left: 4px solid #f5576c; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .oos-list h2 { color: #c53030; margin-bottom: 15px; }
        .location-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #fed7d7; display: flex; justify-content: space-between; align-items: center; }
        .location-name { font-weight: bold; color: #333; }
        .stock-badge { padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; display: inline-block; white-space: nowrap; line-height: 1; }
        .status-cell { text-align: center; }
        .badge-oos { background: #f5576c; color: white; }
        .badge-in-stock { background: #48bb78; color: white; }
        .all-locations { margin-top: 30px; }
        .all-locations h2 { color: #333; margin-bottom: 15px; }
        .table-wrapper { max-height: 60vh; overflow: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; }
        thead { position: sticky; top: 0; z-index: 1; background: #667eea; color: white; }
        th, td { padding: 15px; text-align: left; }
        tbody tr:nth-child(even) { background: #f8f9fa; }
        tbody tr:hover { background: #e9ecef; }
        /* Allow text selection in table and modal */
        td, th { user-select: text; }
        .no-data { text-align: center; padding: 40px; color: #999; font-style: italic; }
        .dragover { border-color: #1890ff !important; background: #e6f7ff !important; }
        .controls { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .secondary-btn { background: #edf2ff; color: #334155; padding: 10px 16px; border: 1px solid #c7d2fe; border-radius: 5px; font-size: 14px; cursor: pointer; }
        /* Modal */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; width: min(900px, 90vw); max-height: 80vh; overflow: auto; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1001; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #eee; }
        .modal-title { font-weight: 600; color: #333; }
        .modal-close { background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .modal-body { padding: 16px 20px; }
        /* Floating Home button pattern */
        .home-fab { position: fixed; right: 20px; bottom: 20px; background: #edf2ff; color: #334155; border: 1px solid #c7d2fe; border-radius: 999px; padding: 10px 14px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; z-index: 1002; }
        .home-fab:hover { background: #e0e7ff; }
    </style>
</head>
<body>
    <div class="container">
        <div style="display:grid; grid-template-columns: 1fr auto; align-items:center; gap:12px;">
            <div style="text-align:center;">
                <h1 style="margin:0; text-align:center;">üì¶ Stock Availability Checker</h1>
                <p class="subtitle" style="margin-top:6px; text-align:center;">Upload your stock file to identify out-of-stock locations</p>
            </div>
            
        </div>

        

        <div id="dropZone" class="upload-section" title="Drag & drop file here">
            <input type="file" id="fileInput" class="file-input" accept=".csv,.txt,.xlsx">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">üìÅ Choose Stock File</button>
            <div class="controls">
                
                <button class="secondary-btn" id="resetView" disabled>Reset</button>
            </div>
            <div id="fileInfo" class="file-info"></div>
            <div id="sheetSelectorContainer" class="controls" style="display:none; margin-top: 15px;">
                <label for="sheetSelector">Organisation:</label>
                <select id="sheetSelector" class="secondary-btn" style="min-width: 240px;"></select>
            </div>
            <div id="searchContainer" class="controls" style="margin-top: 15px;">
                <input id="searchInput" type="text" class="secondary-btn" placeholder="Search by SKU, Description, Subinventory" style="flex:1; min-width: 300px;" autocomplete="off" autocapitalize="none" spellcheck="false" />
                <button class="secondary-btn" id="clearSearch" title="Clear search">Clear</button>
            </div>
        </div>

        <div id="results" class="results" style="display: none;">
            <div class="summary">
                <div class="summary-card oos" id="cardOOS" style="cursor:pointer" title="Click to view details">
                    <h3>Out of Stock</h3>
                    <div class="value" id="oosCount">0</div>
                </div>
                <div class="summary-card in-stock" id="cardInStock" style="cursor:pointer" title="Click to view details">
                    <h3>In Stock</h3>
                    <div class="value" id="inStockCount">0</div>
                </div>
                <div class="summary-card" id="cardTransfer" style="cursor:pointer" title="Click to view transfer candidates">
                    <h3>Transfer Candidates</h3>
                    <div class="value" id="transferCount">0</div>
                </div>
            </div>

            <div class="summary" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                <div class="card" style="background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:14px;">
                    <h3 style="margin-bottom:8px; color:#333">Stock Status Breakdown</h3>
                    <canvas id="pieChart" height="160" aria-label="In Stock vs OOS" role="img"></canvas>
                </div>
                <div class="card" style="background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:14px;">
                    <h3 style="margin-bottom:8px; color:#333">Quantity by Location</h3>
                    <canvas id="barChart" height="160" aria-label="Quantity by Location" role="img"></canvas>
                </div>
            </div>

            

            <div class="all-locations">
                <h2>All Locations</h2>
                <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for details -->
    <div id="detailsBackdrop" class="modal-backdrop">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="detailsTitle">Details</div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="secondary-btn" id="detailsBack" style="display:none">Back</button>
                <button class="modal-close" id="detailsClose">Close</button>
                </div>
            </div>
            <div class="modal-body">
                <table style="width:100%" id="detailsTable">
                    <thead>
                        <tr id="detailsHeader"></tr>
                    </thead>
                    <tbody id="detailsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Consistent floating Home button -->
    <a href="index.html" class="home-fab" title="Back to Home">üè† Home</a>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2/dist/chartjs-plugin-datalabels.min.js"></script>
    <script>
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const resetBtn = document.getElementById('resetView');
        
        const sheetSelector = document.getElementById('sheetSelector');
        const sheetSelectorContainer = document.getElementById('sheetSelectorContainer');
        const searchInput = document.getElementById('searchInput');
        const cardOOS = document.getElementById('cardOOS');
        const cardInStock = document.getElementById('cardInStock');
        const cardTransfer = document.getElementById('cardTransfer');
        const detailsBackdrop = document.getElementById('detailsBackdrop');
        const detailsClose = document.getElementById('detailsClose');
        const detailsHeader = document.getElementById('detailsHeader');
        const detailsBody = document.getElementById('detailsBody');
        const detailsTitle = document.getElementById('detailsTitle');
        const detailsBack = document.getElementById('detailsBack');

        let currentWorkbook = null;
        let currentData = [];
        let currentHeaders = [];
        let currentFilteredData = [];
        let currentSheetName = '';
        let currentTransitHeaders = [];
        // Sorting state
        let sortColumn = null; // header name
        let sortDirection = 'desc'; // 'asc' | 'desc'

        // Register Chart.js Data Labels plugin (for pie percentages)
        if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
        }

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileInfo').textContent = `Selected: ${file.name}`;
                // Collapse upload section after selection
                dropZone.classList.add('collapsed');
                readFile(file);
            }
        });

        ['dragenter','dragover'].forEach(evt => dropZone.addEventListener(evt, (e) => {
            e.preventDefault(); e.stopPropagation(); dropZone.classList.add('dragover');
        }));
        ['dragleave','drop'].forEach(evt => dropZone.addEventListener(evt, (e) => {
            e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('dragover');
        }));
        dropZone.addEventListener('drop', (e) => {
            const file = e.dataTransfer.files[0];
            if (file) {
                document.getElementById('fileInfo').textContent = `Selected: ${file.name}`;
                // Collapse upload section after drop
                dropZone.classList.add('collapsed');
                readFile(file);
            }
        });

        function readFile(file) {
            const ext = (file.name.split('.').pop() || '').toLowerCase();
            if (ext === 'xlsx') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        currentWorkbook = workbook;
                        populateSheetSelector(workbook.SheetNames);
                        // Auto-load All for convenience
                        if (workbook.SheetNames.length > 0) {
                            loadAllSheets();
                        }
                };
                reader.readAsArrayBuffer(file);
            } else {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    parseAndDisplay(content);
                };
                reader.readAsText(file);
            }
        }

        function populateSheetSelector(names) {
            sheetSelector.innerHTML = '';
                // Add an "All" option to include every organisation
                if (names && names.length) {
                    const optAll = document.createElement('option');
                    optAll.value = '__ALL__';
                    optAll.textContent = 'All';
                    sheetSelector.appendChild(optAll);
                }
                names.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    sheetSelector.appendChild(opt);
                });
                // Always show selector when there are sheets; default to All if present
                sheetSelectorContainer.style.display = (names && names.length) ? 'flex' : 'none';
                if (names && names.length) {
                    sheetSelector.value = '__ALL__';
                }
        }

        sheetSelector.addEventListener('change', (e) => {
            const name = e.target.value;
            if (name === '__ALL__') {
                loadAllSheets();
            } else {
                loadSheet(name);
            }
        });

        function loadSheet(sheetName) {
            if (!currentWorkbook) return;
            const sheet = currentWorkbook.Sheets[sheetName];
            if (!sheet) return;
            // Track current sheet name for organisation-specific logic
            currentSheetName = sheetName;
            // Headers start at Excel row 5 (0-based index 4)
            const json = XLSX.utils.sheet_to_json(sheet, { defval: '', range: 4 });
            parseStructured(json);
        }
        function loadAllSheets() {
            if (!currentWorkbook) return;
            const allNames = currentWorkbook.SheetNames || [];
            let combined = [];
            allNames.forEach(sheetName => {
                const sheet = currentWorkbook.Sheets[sheetName];
                if (!sheet) return;
                const json = XLSX.utils.sheet_to_json(sheet, { defval: '', range: 4 });
                combined = combined.concat(json);
            });
            currentSheetName = 'all';
            parseStructured(combined);
        }

        function parseStructured(rows) {
            if (!rows || rows.length === 0) {
                alert('The Excel file appears to be empty.');
                return;
            }
            const headers = Object.keys(rows[0]);
            currentTransitHeaders = headers.slice(10, Math.min(26, headers.length));
            // Identify required columns
            const itemDescCol = findColumn(headers, ['item description','description']);
            const itemCol = findColumn(headers, ['item','item code','sku']);
            const subinvCol = findColumn(headers, ['subinventory','sub inventory','sub inv']);
            const balanceCol = findColumn(headers, ['balance','on hand','available','qty','quantity']);

            if (!itemDescCol || !itemCol || !subinvCol || !balanceCol) {
                alert('Could not find required columns: Item Description, Item, Subinventory, Balance.');
                return;
            }

            // Reduce to required columns and normalize
            const data = rows.map(r => {
                const baseItem = String(r[itemCol] ?? '').trim();
                const desc = r[itemDescCol] ?? '';
                // Explicitly extract SKU from the 'Item' column (starting at Excel row 5)
                const finalItem = baseItem;

                const inTransit = computeInTransitFromRow(r, headers);
                const transitBreakdown = computeTransitBreakdown(r, headers);

                return {
                    'Item Description': desc,
                    'Item': finalItem,
                    'Subinventory': String(r[subinvCol] ?? '').toUpperCase(),
                    'Balance': r[balanceCol] ?? '',
                    'In Transit': inTransit,
                    _transitBreakdown: transitBreakdown
                };
            });

            // Prepare rows; new OOS logic based on SKU coverage across locations
            data.forEach(row => {
                const stockRaw = row['Balance'];
                const stock = parseFloat(String(stockRaw).replace(/[^0-9.-]/g, '')) || 0;
                row._stock = stock;
                row._location = row['Subinventory'] || row['Item'];
                row._isOOS = false;
            });

            currentData = data;
            currentHeaders = ['Item Description','Item','Subinventory','Balance','In Transit'];
            ensureDs5Locations();
            ensureDs6Locations();
            ensureDs7Locations();
            recomputeOOSByCoverage();
            applySearchAndDisplay();
        }

        function parseAndDisplay(content) {
            const normalized = content.replace(/\r\n?|\n/g, '\n');
            const delimiter = normalized.includes('\t') ? '\t' : ',';
            const lines = normalized.split('\n').filter(line => line.trim());

            if (lines.length < 2) {
                alert('File must contain at least a header row and one data row.');
                return;
            }

            const headers = splitRow(lines[0], delimiter).map(h => h.trim());
            currentTransitHeaders = headers.slice(10, Math.min(26, headers.length));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = splitRow(lines[i], delimiter).map(v => v.trim());
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] ?? '';
                });
                data.push(row);
            }

            const locationCol = findColumn(headers, ['location','store','warehouse','site','branch','name']);
            const stockCol = findColumn(headers, ['stock','quantity','qty','available','inventory','count']);

            if (!locationCol || !stockCol) {
                alert('Could not identify location and stock columns. Ensure headers like "Location" and "Stock" exist.');
                return;
            }

            // Prepare rows; status determined by SKU coverage across locations
            data.forEach(row => {
                const location = String(row[locationCol] ?? '').toUpperCase();
                const stockRaw = row[stockCol];
                const stock = parseFloat(String(stockRaw).replace(/[^0-9.-]/g, '')) || 0;
                row._isOOS = false;
                row._location = location;
                row._stock = stock;
                // Compute In Transit for CSV/TXT based on columns K..Z if present
                row['In Transit'] = computeInTransitFromRow(row, headers);
                row._transitBreakdown = computeTransitBreakdown(row, headers);
            });

            currentData = data;
            currentHeaders = headers.includes('In Transit') ? headers : [...headers, 'In Transit'];
            recomputeOOSByCoverage();
            applySearchAndDisplay();
        }

        // Ensure DS5 includes three specific locations for every SKU; missing ones are marked OOS
        function ensureDs5Locations() {
            try {
                const name = (typeof sheetSelector !== 'undefined' && sheetSelector && sheetSelector.value) ? String(sheetSelector.value).trim().toLowerCase() : String(currentSheetName || '').trim().toLowerCase();
                if (name !== 'ds5') return;
                const required = ['FG-APK-SG','B2C-APK-LZ','B2C-APK-SP'];
                // Build coverage per SKU
                const skuLocs = new Map();
                currentData.forEach(r => {
                    const sku = String(r['Item'] ?? '').trim();
                    const loc = String(r['Subinventory'] ?? r._location ?? '').trim().toUpperCase();
                    if (!sku) return;
                    if (!skuLocs.has(sku)) skuLocs.set(sku, new Set());
                    if (loc) skuLocs.get(sku).add(loc);
                });
                const additions = [];
                skuLocs.forEach((locSet, sku) => {
                    required.forEach(req => {
                        if (!locSet.has(req)) {
                            const sample = currentData.find(r => String(r['Item'] ?? '').trim() === sku);
                            additions.push({
                                'Item Description': sample ? sample['Item Description'] : '',
                                'Item': sku,
                                'Subinventory': req,
                                'Balance': '',
                                'In Transit': 0,
                                _stock: 0,
                                _location: req,
                                _isOOS: true,
                                _synthetic: true
                            });
                        }
                    });
                });
                if (additions.length) {
                    currentData = currentData.concat(additions);
                }
            } catch (e) { /* ignore */ }
        }

        // Ensure DS6 includes specific locations for every SKU; missing ones are marked OOS
        function ensureDs6Locations() {
            try {
                const name = (typeof sheetSelector !== 'undefined' && sheetSelector && sheetSelector.value) ? String(sheetSelector.value).trim().toLowerCase() : String(currentSheetName || '').trim().toLowerCase();
                if (name !== 'ds6') return;
                const required = ['B2C-AMG-AU','FBA-NSW-AU','GIT-FBA-AU'];
                const skuLocs = new Map();
                currentData.forEach(r => {
                    const sku = String(r['Item'] ?? '').trim();
                    const loc = String(r['Subinventory'] ?? r._location ?? '').trim().toUpperCase();
                    if (!sku) return;
                    if (!skuLocs.has(sku)) skuLocs.set(sku, new Set());
                    if (loc) skuLocs.get(sku).add(loc);
                });
                const additions = [];
                skuLocs.forEach((locSet, sku) => {
                    required.forEach(req => {
                        if (!locSet.has(req)) {
                            const sample = currentData.find(r => String(r['Item'] ?? '').trim() === sku);
                            additions.push({
                                'Item Description': sample ? sample['Item Description'] : '',
                                'Item': sku,
                                'Subinventory': req,
                                'Balance': '',
                                'In Transit': 0,
                                _stock: 0,
                                _location: req,
                                _isOOS: true,
                                _synthetic: true
                            });
                        }
                    });
                });
                if (additions.length) {
                    currentData = currentData.concat(additions);
                }
            } catch (e) { /* ignore */ }
        }

        // Ensure DS7 includes specific locations for every SKU; missing ones are marked OOS
        function ensureDs7Locations() {
            try {
                const name = (typeof sheetSelector !== 'undefined' && sheetSelector && sheetSelector.value) ? String(sheetSelector.value).trim().toLowerCase() : String(currentSheetName || '').trim().toLowerCase();
                if (name !== 'ds7') return;
                const required = ['B2C-VLC-MY','B2C-VLC-SP','B2C-VLC-LZ'];
                const skuLocs = new Map();
                currentData.forEach(r => {
                    const sku = String(r['Item'] ?? '').trim();
                    const loc = String(r['Subinventory'] ?? r._location ?? '').trim().toUpperCase();
                    if (!sku) return;
                    if (!skuLocs.has(sku)) skuLocs.set(sku, new Set());
                    if (loc) skuLocs.get(sku).add(loc);
                });
                const additions = [];
                skuLocs.forEach((locSet, sku) => {
                    required.forEach(req => {
                        if (!locSet.has(req)) {
                            const sample = currentData.find(r => String(r['Item'] ?? '').trim() === sku);
                            additions.push({
                                'Item Description': sample ? sample['Item Description'] : '',
                                'Item': sku,
                                'Subinventory': req,
                                'Balance': '',
                                'In Transit': 0,
                                _stock: 0,
                                _location: req,
                                _isOOS: true,
                                _synthetic: true
                            });
                        }
                    });
                });
                if (additions.length) {
                    currentData = currentData.concat(additions);
                }
            } catch (e) { /* ignore */ }
        }

        function splitRow(line, delimiter) {
            if (delimiter === ',') {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        if (inQuotes && line[i+1] === '"') { current += '"'; i++; }
                        else { inQuotes = !inQuotes; }
                    } else if (char === ',' && !inQuotes) {
                        result.push(current); current = '';
                    } else { current += char; }
                }
                result.push(current);
                return result;
            }
            return line.split('\t');
        }

        function findColumn(headers, possibleNames) {
            const lower = headers.map(h => h.toLowerCase());
            // 1) Prefer exact match
            for (let name of possibleNames) {
                const lname = name.toLowerCase();
                const idx = lower.indexOf(lname);
                if (idx !== -1) return headers[idx];
            }
            // 2) Prefer word-boundary match
            for (let name of possibleNames) {
                const lname = name.toLowerCase();
                const re = new RegExp(`(^|\\b)${lname}(\\b|$)`);
                const idx = lower.findIndex(h => re.test(h));
                if (idx !== -1) return headers[idx];
            }
            // 3) Fallback to includes, but avoid ambiguous matches (e.g., 'item' matching 'item description')
            for (let name of possibleNames) {
                const lname = name.toLowerCase();
                let idx = lower.findIndex(h => h.includes(lname) && !(lname === 'item' && h.includes('description')));
                if (idx !== -1) return headers[idx];
            }
            return null;
        }

        function displayResults(data, oosLocations, inStockLocations, headers) {
            // Total Locations card removed; only update OOS/In Stock
            document.getElementById('oosCount').textContent = oosLocations.length;
            document.getElementById('inStockCount').textContent = inStockLocations.length;
            const candidates = computeTransferCandidates();
            document.getElementById('transferCount').textContent = candidates.length;

            // Removed out-of-stock locations list rendering per user request

            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';

            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header + (sortColumn === header ? (sortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : '');
                th.style.cursor = 'pointer';
                th.title = 'Click to sort';
                th.addEventListener('click', () => handleSort(header));
                tableHeader.appendChild(th);
            });
            const statusTh = document.createElement('th');
            statusTh.className = 'status-cell';
            statusTh.textContent = 'Status';
            tableHeader.appendChild(statusTh);

            // Apply sorting if active
            const working = [...data];
            if (sortColumn) {
                const isNumeric = ['Balance','In Transit'].includes(sortColumn);
                working.sort((a, b) => {
                    const av = a[sortColumn];
                    const bv = b[sortColumn];
                    let cmp;
                    if (isNumeric) {
                        const an = parseFloat(String(av ?? '').replace(/[^0-9.-]/g, '')) || 0;
                        const bn = parseFloat(String(bv ?? '').replace(/[^0-9.-]/g, '')) || 0;
                        cmp = an - bn;
                    } else {
                        const as = String(av ?? '').toLowerCase();
                        const bs = String(bv ?? '').toLowerCase();
                        cmp = as < bs ? -1 : as > bs ? 1 : 0;
                    }
                    return sortDirection === 'asc' ? cmp : -cmp;
                });
            }

            working.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header];
                    if (header === 'In Transit') {
                        td.style.cursor = 'pointer';
                        td.title = 'Click to view ETA breakdown';
                        td.addEventListener('click', () => { openTransitDetails(row); });
                    }
                    tr.appendChild(td);
                });
                // Row click: show all locations for this SKU
                tr.style.cursor = 'pointer';
                tr.title = 'Click to view all locations for this SKU';
                tr.addEventListener('click', (e) => {
                    // Avoid double-trigger when clicking on the In Transit cell
                    if (e.target && e.target.tagName === 'TD' && e.target.title === 'Click to view ETA breakdown') return;
                    // If user is selecting text, do not navigate
                    const sel = window.getSelection ? String(window.getSelection()) : '';
                    if (sel && sel.length > 0) return;
                    const sku = String(row['Item'] ?? '').trim();
                    if (!sku) return;
                    // Remember last clicked row id
                    window.__lastClickedRowId = { sku, loc: String(row['Subinventory'] ?? row['_location'] ?? '').trim() };
                    const allForSku = currentData.filter(r => String(r['Item'] ?? '').trim() === sku);
                    navigateToDetails(`All Locations for ${sku}`, allForSku, false);
                });
                const statusTd = document.createElement('td');
                statusTd.className = 'status-cell';
                const badge = document.createElement('span');
                badge.className = `stock-badge ${row._isOOS ? 'badge-oos' : 'badge-in-stock'}`;
                badge.textContent = row._isOOS ? 'OOS' : 'IN STOCK';
                statusTd.appendChild(badge);
                tr.appendChild(statusTd);
                tableBody.appendChild(tr);
            });

            document.getElementById('results').style.display = 'block';
            resetBtn.disabled = false;

            // Render charts
            renderCharts(data);
        }
        function renderCharts(data) {
            try {
                const pieEl = document.getElementById('pieChart');
                const barEl = document.getElementById('barChart');
                if (!pieEl || !barEl) return;

                const base = (currentFilteredData && currentFilteredData.length) ? currentFilteredData : data;
                const oosCount = base.filter(r => r._isOOS).length;
                const inStockCount = base.filter(r => !r._isOOS).length;

                // Pie chart: In Stock vs OOS
                if (pieEl.__chart) { pieEl.__chart.destroy(); }
                const pie = new Chart(pieEl, {
                    type: 'pie',
                    data: {
                        labels: ['In Stock','Out of Stock'],
                        datasets: [{
                            data: [inStockCount, oosCount],
                            backgroundColor: ['#4facfe','#f5576c'],
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom' },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    const data = ctx.chart.data.datasets[0].data || [];
                                    const total = data.reduce((a, b) => a + b, 0);
                                    const pct = total ? (value / total) * 100 : 0;
                                    return `${pct.toFixed(1)}%`;
                                },
                                color: '#ffffff',
                                font: { weight: 'bold' }
                            }
                        },
                        onClick: (evt, elements) => {
                            const idx = elements?.[0]?.index;
                            if (idx === 0) {
                                const inStock = base.filter(r => !r._isOOS);
                                modalStack = [];
                                openDetails('In Stock Details', inStock);
                            } else if (idx === 1) {
                                const oos = base.filter(r => r._isOOS);
                                modalStack = [];
                                openDetails('Out of Stock Details', oos);
                            }
                        }
                    }
                });
                pieEl.__chart = pie;

                // Bar chart: quantity by location (sum of Balance per Subinventory)
                const totalsByLoc = new Map();
                base.forEach(r => {
                    const loc = String(r['Subinventory'] ?? r._location ?? '').trim();
                    const stock = typeof r._stock === 'number' ? r._stock : (parseFloat(String(r['Balance'] ?? '').replace(/[^0-9.-]/g, '')) || 0);
                    if (!loc) return;
                    totalsByLoc.set(loc, (totalsByLoc.get(loc) || 0) + stock);
                });
                const labels = Array.from(totalsByLoc.keys());
                const values = labels.map(l => totalsByLoc.get(l));

                if (barEl.__chart) { barEl.__chart.destroy(); }
                const bar = new Chart(barEl, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Quantity',
                            data: values,
                            backgroundColor: '#667eea'
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false }, datalabels: { display: false } },
                        onClick: (evt, elements) => {
                            const idx = elements?.[0]?.index;
                            if (idx == null) return;
                            const loc = labels[idx];
                            const rows = base.filter(r => String(r['Subinventory'] ?? r._location ?? '').trim() === loc);
                            modalStack = [];
                            openDetails(`Available at ${loc}`, rows);
                        }
                    }
                });
                barEl.__chart = bar;
            } catch (e) { /* ignore chart errors */ }
        }

        // Search filtering
        function applySearchAndDisplay() {
            const q = (searchInput.value || '').trim().toLowerCase();
            if (!q) {
                // Recompute status groups for counts
                const oos = []; const inStock = [];
                currentData.forEach(row => (row._isOOS ? oos : inStock).push(row));
                currentFilteredData = currentData;
                displayResults(currentFilteredData, oos, inStock, currentHeaders);
                return;
            }
            const filtered = currentData.filter(row => {
                const sku = String(row['Item'] ?? '').toLowerCase();
                const desc = String(row['Item Description'] ?? '').toLowerCase();
                const loc = String(row['Subinventory'] ?? row['_location'] ?? '').toLowerCase();
                return sku.includes(q) || desc.includes(q) || loc.includes(q);
            });
            const oos = []; const inStock = [];
            filtered.forEach(row => (row._isOOS ? oos : inStock).push(row));
            currentFilteredData = filtered;
            displayResults(currentFilteredData, oos, inStock, currentHeaders);
        }

        function handleSort(header) {
            if (sortColumn === header) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = header;
                sortDirection = 'desc';
            }
            const base = (currentFilteredData && currentFilteredData.length) ? currentFilteredData : currentData;
            const oos = []; const inStock = [];
            base.forEach(row => (row._isOOS ? oos : inStock).push(row));
            displayResults(base, oos, inStock, currentHeaders);
        }

        searchInput.addEventListener('input', applySearchAndDisplay);
        // Clear search button
        const clearSearchBtn = document.getElementById('clearSearch');
        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', () => {
                try {
                    searchInput.value = '';
                    applySearchAndDisplay();
                } catch (e) { /* ignore */ }
            });
        }

        // Sum columns K..Z (indexes 10..25) as In Transit
        function computeInTransitFromRow(row, headers) {
            let sum = 0;
            const start = 10; // K
            const end = Math.min(26, headers.length); // up to Z (exclusive)
            for (let i = start; i < end; i++) {
                const key = headers[i];
                const v = row[key];
                const n = parseFloat(String(v ?? '').replace(/[^0-9.-]/g, ''));
                if (!isNaN(n)) sum += n;
            }
            return sum;
        }

        function computeTransitBreakdown(row, headers) {
            const breakdown = [];
            const start = 10;
            const end = Math.min(26, headers.length);
            for (let i = start; i < end; i++) {
                const key = headers[i];
                const v = row[key];
                const n = parseFloat(String(v ?? '').replace(/[^0-9.-]/g, ''));
                if (!isNaN(n) && n !== 0) breakdown.push({ key, value: n });
            }
            return breakdown;
        }

        // New OOS logic: mark a SKU OOS at any location if the SKU does not appear in all locations (missing rows considered OOS)
        function recomputeOOSByCoverage() {
            const allLocations = new Set();
            currentData.forEach(r => {
                const loc = String(r['Subinventory'] ?? r._location ?? '').trim();
                if (loc) allLocations.add(loc);
            });
            const totalLocations = allLocations.size;
            if (totalLocations === 0) return;

            const coverage = new Map();
            currentData.forEach(r => {
                const sku = String(r['Item'] ?? r['item'] ?? '').trim();
                const loc = String(r['Subinventory'] ?? r._location ?? '').trim();
                if (!sku || !loc) return;
                if (!coverage.has(sku)) coverage.set(sku, new Set());
                coverage.get(sku).add(loc);
            });

            // Updated: Include back rows with Balance = 0 as OOS (non-synthetic).
            currentData.forEach(r => {
                if (!r._synthetic) {
                    const stock = typeof r._stock === 'number' ? r._stock : (parseFloat(String(r['Balance'] ?? '').replace(/[^0-9.-]/g, '')) || 0);
                    r._isOOS = stock === 0;
                }
            });
        }

        function computeTransferCandidates() {
            const name = (typeof sheetSelector !== 'undefined' && sheetSelector && sheetSelector.value) ? String(sheetSelector.value).trim().toLowerCase() : String(currentSheetName || '').trim().toLowerCase();
            if (!name) return [];
            const bySku = new Map();
            currentData.forEach(r => {
                const sku = String(r['Item'] ?? '').trim();
                const loc = String(r['Subinventory'] ?? r._location ?? '').trim().toUpperCase();
                const stock = typeof r._stock === 'number' ? r._stock : (parseFloat(String(r['Balance'] ?? '').replace(/[^0-9.-]/g, '')) || 0);
                const desc = String(r['Item Description'] ?? '').trim();
                if (!sku || !loc) return;
                if (!bySku.has(sku)) bySku.set(sku, { desc, stocks: new Map() });
                bySku.get(sku).stocks.set(loc, stock);
            });
            const results = [];
            bySku.forEach((info, sku) => {
                const stocks = info.stocks;
                const desc = info.desc;
                const pushCandidate = (sourceLoc, destLocs) => {
                    const availableAt = destLocs.filter(l => (stocks.get(l) || 0) > 0);
                    if ((stocks.get(sourceLoc) || 0) <= 0 && availableAt.length) {
                        results.push({ sku, desc, source: sourceLoc, availableAt });
                    }
                };
                if (name === 'ds5') {
                    pushCandidate('FG-APK-SG', ['B2C-APK-LZ','B2C-APK-SP']);
                } else if (name === 'ds6') {
                    pushCandidate('B2C-AMG-AU', ['FBA-NSW-AU']);
                } else if (name === 'ds7') {
                    pushCandidate('B2C-VLC-MY', ['B2C-VLC-SP','B2C-VLC-LZ']);
                }
            });
            return results;
        }

        function openTransferCandidatesModal() {
            const candidates = computeTransferCandidates();
            detailsTitle.textContent = 'Transfer Candidates';
            detailsHeader.innerHTML = '';
            detailsBody.innerHTML = '';
            // Align column sequence with main table: Description before Item
            const cols = ['Item Description','Item','Source','Available At'];
            cols.forEach(c => { const th = document.createElement('th'); th.textContent = c; detailsHeader.appendChild(th); });
            candidates.forEach(c => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.title = 'Click to view all locations for this SKU';
                tr.addEventListener('click', () => {
                    // Push a marker so Back returns to Transfer Candidates view
                    const modalElPrev = detailsBackdrop.querySelector('.modal');
                    const prevScroll = modalElPrev ? (modalElPrev.scrollTop || 0) : 0;
                    modalStack.push({ title: 'Transfer Candidates', view: 'transfer', scrollTop: prevScroll });
                    const allForSku = currentData.filter(r => String(r['Item'] ?? '').trim() === c.sku);
                    openDetails(`All Locations for ${c.sku}`, allForSku);
                    detailsBack.style.display = 'inline-block';
                });
                // Render cells in the same order as headers
                const tdDesc = document.createElement('td'); tdDesc.textContent = c.desc; tr.appendChild(tdDesc);
                const tdSku = document.createElement('td'); tdSku.textContent = c.sku; tr.appendChild(tdSku);
                const tdSrc = document.createElement('td'); tdSrc.textContent = c.source; tr.appendChild(tdSrc);
                const tdAvail = document.createElement('td'); tdAvail.textContent = c.availableAt.join(', '); tr.appendChild(tdAvail);
                detailsBody.appendChild(tr);
            });
            detailsBackdrop.style.display = 'flex';
            detailsBack.style.display = modalStack.length ? 'inline-block' : 'none';
        }

        // Modal helpers
        let modalStack = [];
        let lastDetailRows = null;
        // Preserve main page scroll position when entering modals
        let pageScrollY = 0;
        // Preserve modal scroll position to avoid jumping to top on back/return
        let modalScrollTop = 0;

        function getPageScrollY() {
            const el = document.scrollingElement || document.documentElement || document.body;
            return el.scrollTop || 0;
        }

        function setPageScrollY(y) {
            const el = document.scrollingElement || document.documentElement || document.body;
            try {
                el.scrollTo(0, y || 0);
            } catch (e) {
                // Fallback
                el.scrollTop = y || 0;
            }
        }

        function openDetails(title, rows) {
            // Capture current page scroll so we can restore on close/back
            pageScrollY = getPageScrollY();
            // If reopening a view, apply prior modal scroll after render
            // Append selected organisation to "All Locations" views
            try {
                const sel = (typeof sheetSelector !== 'undefined' && sheetSelector) ? sheetSelector.value : '';
                const orgName = sel === '__ALL__' ? 'All' : sel || '';
                if (title && title.startsWith('All Locations for') && orgName) {
                    title = `${title} ‚Äî Organisation: ${orgName}`;
                }
            } catch (e) { /* ignore */ }
            detailsTitle.textContent = title;
            detailsHeader.innerHTML = '';
            detailsBody.innerHTML = '';
            // Track the rows shown in the modal for Back navigation
            lastDetailRows = rows;

            // Use currentHeaders; include Status
            currentHeaders.forEach(h => {
                const th = document.createElement('th'); th.textContent = h; detailsHeader.appendChild(th);
            });
            const thStatus = document.createElement('th'); thStatus.className = 'status-cell'; thStatus.textContent = 'Status'; detailsHeader.appendChild(thStatus);

            rows.forEach(row => {
                const tr = document.createElement('tr');
                // Row click shows all locations for this SKU
                tr.style.cursor = 'pointer';
                tr.title = 'Click to view all locations for this SKU';
                tr.addEventListener('click', (e) => {
                    // If clicking on In Transit cell, let its own handler run
                    if (e.target && e.target.tagName === 'TD' && e.target.dataset && e.target.dataset.role === 'transit-cell') return;
                    const sel = window.getSelection ? String(window.getSelection()) : '';
                    if (sel && sel.length > 0) return;
                    const sku = String(row['Item'] ?? '').trim();
                    if (!sku) return;
                    const allForSku = currentData.filter(r => String(r['Item'] ?? '').trim() === sku);
                    navigateToDetails(`All Locations for ${sku}`, allForSku, true);
                });
                currentHeaders.forEach(h => {
                    const td = document.createElement('td');
                    td.textContent = row[h];
                    if (h === 'In Transit') {
                        td.style.cursor = 'pointer';
                        td.title = 'Click to view ETA breakdown';
                        td.dataset.role = 'transit-cell';
                        td.addEventListener('click', (ev) => { ev.stopPropagation(); navigateToTransit(row); });
                    }
                    tr.appendChild(td);
                });
                const statusTd = document.createElement('td');
                statusTd.className = 'status-cell';
                const badge = document.createElement('span');
                badge.className = `stock-badge ${row._isOOS ? 'badge-oos' : 'badge-in-stock'}`;
                badge.textContent = row._isOOS ? 'OOS' : 'IN STOCK';
                statusTd.appendChild(badge);
                tr.appendChild(statusTd);
                detailsBody.appendChild(tr);
            });

            detailsBackdrop.style.display = 'flex';
            detailsBack.style.display = modalStack.length ? 'inline-block' : 'none';
            // Restore modal scroll position if available
            const modalEl = detailsBackdrop.querySelector('.modal');
            if (modalEl) {
                const top = modalStack.length ? (modalStack[modalStack.length - 1].scrollTop ?? modalScrollTop ?? 0) : (modalScrollTop || 0);
                modalEl.scrollTop = top || 0;
            }
        }

        // Helper to navigate into a new details view, preserving the previous one for Back
        function navigateToDetails(title, rows, pushPrevious = true) {
            if (pushPrevious && lastDetailRows) {
                // Preserve the exact row objects including _isOOS flags
                const modalElPrev = detailsBackdrop.querySelector('.modal');
                const prevScroll = modalElPrev ? (modalElPrev.scrollTop || 0) : 0;
                modalStack.push({ title: detailsTitle.textContent, rows: lastDetailRows, scrollTop: prevScroll });
            }
            openDetails(title, rows);
        }

        function navigateToTransit(row) {
            // Push the actual last detail rows so status flags are preserved
            if (lastDetailRows && Array.isArray(lastDetailRows) && lastDetailRows.length) {
                modalStack.push({ title: detailsTitle.textContent, rows: lastDetailRows });
            }
            // Also capture page scroll (in case transit opens first)
            pageScrollY = getPageScrollY();
            // Save current modal scroll before switching view
            const modalElPrev = detailsBackdrop.querySelector('.modal');
            if (modalElPrev) { modalScrollTop = modalElPrev.scrollTop || 0; }
            openTransitDetails(row);
            detailsBack.style.display = 'inline-block';
        }

        function openTransitDetails(row) {
            // Capture page scroll before showing modal
            pageScrollY = getPageScrollY();
            detailsTitle.textContent = 'In Transit ETA Breakdown';
            detailsHeader.innerHTML = '';
            detailsBody.innerHTML = '';
            const th1 = document.createElement('th'); th1.textContent = 'ETA'; detailsHeader.appendChild(th1);
            const th2 = document.createElement('th'); th2.textContent = 'Quantity'; detailsHeader.appendChild(th2);
            const breakdown = Array.isArray(row._transitBreakdown) ? row._transitBreakdown : [];
            if (breakdown.length === 0) {
                const tr = document.createElement('tr');
                const td1 = document.createElement('td'); td1.textContent = 'No transit details'; tr.appendChild(td1);
                const td2 = document.createElement('td'); td2.textContent = ''; tr.appendChild(td2);
                detailsBody.appendChild(tr);
            } else {
                breakdown.forEach(({ key, value }) => {
                    const tr = document.createElement('tr');
                    const td1 = document.createElement('td'); td1.textContent = key; tr.appendChild(td1);
                    const td2 = document.createElement('td'); td2.textContent = String(value); tr.appendChild(td2);
                    detailsBody.appendChild(tr);
                });
            }
            detailsBackdrop.style.display = 'flex';
            // Restore modal scroll on transit view
            const modalEl = detailsBackdrop.querySelector('.modal');
            if (modalEl) { modalEl.scrollTop = modalScrollTop || 0; }
        }

        detailsClose.addEventListener('click', () => { detailsBackdrop.style.display = 'none'; modalStack = []; lastDetailRows = null; detailsBack.style.display = 'none'; setPageScrollY(pageScrollY || 0); modalScrollTop = 0; });
        detailsBack.addEventListener('click', () => {
            // Save current modal scroll before going back
            const modalElPrev = detailsBackdrop.querySelector('.modal');
            if (modalElPrev) { modalScrollTop = modalElPrev.scrollTop || 0; }
            const prev = modalStack.pop();
            if (!prev) return;
            if (prev.view === 'transfer') {
                // Restore Transfer Candidates view
                openTransferCandidatesModal();
            } else {
                openDetails(prev.title, prev.rows);
            }
            detailsBack.style.display = modalStack.length ? 'inline-block' : 'none';
            // Do NOT change page scroll on in-modal Back; only restore modal scroll
            const modalEl = detailsBackdrop.querySelector('.modal');
            if (modalEl) {
                const top = (prev.scrollTop ?? modalScrollTop ?? 0);
                modalEl.scrollTop = top || 0;
            }
        });
        detailsBackdrop.addEventListener('click', (e) => {
            if (e.target === detailsBackdrop) { detailsBackdrop.style.display = 'none'; setPageScrollY(pageScrollY || 0); restoreFocusToLastRow(); modalScrollTop = 0; }
        });

        // Card click handlers
        cardOOS.addEventListener('click', () => {
            const base = (currentFilteredData && currentFilteredData.length) ? currentFilteredData : currentData;
            const oos = base.filter(r => r._isOOS);
            modalStack = [];
            openDetails('Out of Stock Details', oos);
        });
        cardInStock.addEventListener('click', () => {
            const base = (currentFilteredData && currentFilteredData.length) ? currentFilteredData : currentData;
            const inStock = base.filter(r => !r._isOOS);
            modalStack = [];
            openDetails('In Stock Details', inStock);
        });

        cardTransfer.addEventListener('click', () => {
            modalStack = [];
            openTransferCandidatesModal();
        });

        

        resetBtn.addEventListener('click', () => {
            document.getElementById('results').style.display = 'none';
            
            document.getElementById('fileInfo').textContent = '';
            document.getElementById('tableHeader').innerHTML = '';
            document.getElementById('tableBody').innerHTML = '';
            document.getElementById('oosCount').textContent = '0';
            document.getElementById('inStockCount').textContent = '0';
            resetBtn.disabled = true;
            // Expand upload section again
            dropZone.classList.remove('collapsed');
        });

        // Helper: remember clicked row and restore focus after closing/back
        function restoreFocusToLastRow() {
            try {
                const tbody = document.getElementById('tableBody');
                const headerRow = Array.from(document.getElementById('tableHeader').querySelectorAll('th')).map(th => th.textContent);
                if (!tbody || !headerRow || headerRow.length === 0) return;
                const idxSku = headerRow.indexOf('Item');
                const idxLoc = headerRow.indexOf('Subinventory');
                if (idxSku < 0) return;
                // Find the first row whose SKU was last interacted with (stored on window)
                const id = window.__lastClickedRowId;
                if (!id) return;
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const target = rows.find(tr => {
                    const cells = tr.querySelectorAll('td');
                    const skuText = (cells[idxSku] ? cells[idxSku].textContent.trim() : '');
                    if (skuText !== id.sku) return false;
                    if (idxLoc >= 0 && id.loc) {
                        const locText = (cells[idxLoc] ? cells[idxLoc].textContent.trim() : '');
                        return locText === id.loc;
                    }
                    return true;
                });
                if (target) {
                    target.scrollIntoView({ block: 'center', inline: 'nearest' });
                }
            } catch (e) { /* ignore */ }
        }
    </script>
</body>
</html>
